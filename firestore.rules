rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      
      allow write: if request.auth != null && request.auth.uid == userId 
                   // 1. Proteção Premium e Stripe ID (Sistema)
                   && (!exists(/databases/$(database)/documents/users/$(userId)) 
                       ? (request.resource.data.isPremium != true && !('stripeCustomerId' in request.resource.data))
                       : (request.resource.data.isPremium == resource.data.isPremium 
                          && request.resource.data.stripeCustomerId == resource.data.stripeCustomerId))
                   
                   // 2. Proteção de Estrutura
                   && request.resource.data.keys().hasOnly(['history', 'isPremium', 'stripeCustomerId'])
                   && request.size < 5 * 1024
                   
                   // 3. Integridade do Histórico (Regex para YYYY-MM-DD)
                   && request.resource.data.history.size() < 1000
                   && request.resource.data.history.values().all(val => val is number && val >= 0)
                   && request.resource.data.history.keys().all(key => key.matches('^\\d{4}-\\d{2}-\\d{2}$'));
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
